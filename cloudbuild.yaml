# Code Generated by Sidekick is for learning and experimentation purposes only.
# cloudbuild.yaml: End-to-end CI/CD for GCP Cloud Function (2nd Gen)

options:
  logging: CLOUD_LOGGING_ONLY  # Ensures build works with custom service account

substitutions:
  _REGION: us-central1
  _REPO: functions-repo
  _FUNC_NAME: hello-fn

steps:
  # Step 1: Install dependencies and (optionally) run tests
  - name: 'python:3.11'
    entrypoint: bash
    args:
      - -c
      - |
        pip install -r requirements.txt
        echo "No tests yet â€“ skipping."

  # Step 2: Build container image for Cloud Function using Buildpacks
  - name: 'gcr.io/cloud-builders/pack'
    args:
      - build
      - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_FUNC_NAME:${SHORT_SHA}"
      - --path
      - .
      - --builder
      - gcr.io/buildpacks/builder:v1

  # Step 3: Deploy Cloud Function (2nd Gen)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      - functions
      - deploy
      - "$_FUNC_NAME"
      - --gen2
      - --region=$_REGION
      - --runtime=python311
      - --source=.
      - --entry-point=app
      - --trigger-http
      - --allow-unauthenticated

images:
  - "$_REGION-docker.pkg.dev/$PROJECT_ID/$_REPO/$_FUNC_NAME:${SHORT_SHA}"

